name: Django CI/CD with Auto-Deploy

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    - run: pip install -r requirements.txt
    - run: python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Server
      env:
        SSH_KEY: ${{ vars.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ vars.SERVER_HOST }}
        SERVER_USER: ${{ vars.SERVER_USER }}
        DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º
        TEMP_KEY=$(mktemp)
        echo "$SSH_KEY" | base64 -d > "$TEMP_KEY"
        chmod 600 "$TEMP_KEY"
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        scp -r -i "$TEMP_KEY" ./* $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh -i "$TEMP_KEY" $SERVER_USER@$SERVER_HOST "
          cd $DEPLOY_PATH
          python3 -m pip install -r requirements.txt
          python3 manage.py migrate
          echo 'üéâ DEPLOYMENT SUCCESSFUL!'
        "
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        rm -f "$TEMP_KEY"